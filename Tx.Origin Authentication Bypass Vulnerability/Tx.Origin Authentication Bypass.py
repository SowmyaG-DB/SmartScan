import networkx as nx
import subprocess
import os
import matplotlib.pyplot as plt

# Paths to required files and binaries
smv_file = "C:\\Users\\hp\\Documents\\2025 prjs\\Mrs. Soumya\\model.smv"
nuxmv_path = "C:\\Users\\hp\\Documents\\2025 prjs\\Mrs. Soumya\\nuXmv-2.1.0-win64\\nuXmv-2.1.0-win64\\bin\\nuXmv.exe"
command_file = "C:\\Users\\hp\\Documents\\2025 prjs\\Mrs. Soumya\\commands.txt"

# Step 1: Solidity to BIP Conversion
def solidity_to_bip(solidity_code):
    """Converts Solidity code to a BIP model."""
    functions = extract_functions(solidity_code)
    state_variables = extract_state_variables(solidity_code)
    control_flows = extract_control_flows(solidity_code)

    # Generate BIP model
    bip_model = {
        "functions": functions,
        "state_variables": state_variables,
        "control_flows": control_flows,
    }
    return bip_model

def extract_functions(solidity_code):
    """Extracts functions from Solidity code."""
    return ["withdrawAll"]

def extract_state_variables(solidity_code):
    """Extracts state variables from Solidity code."""
    return ["owner"]

def extract_control_flows(solidity_code):
    """Extracts control flow structures from Solidity code."""
    return ["require"]

# Step 2: BIP to FSM Conversion
def bip_to_fsm(bip_model):
    """Converts BIP model to FSM."""
    fsm = nx.DiGraph()

    states = ["Start", "WithdrawAttempted", "FundsWithdrawn"]
    transitions = [
        ("Start", "WithdrawAttempted"),
        ("WithdrawAttempted", "FundsWithdrawn"),
    ]

    fsm.add_nodes_from(states)
    fsm.add_edges_from(transitions)

    return fsm

# Step 3: Symbolic Model Checking with NuXmv
def write_smv_file(fsm, ctl_properties, output_file="model.smv"):
    """Writes FSM and CTL properties to an SMV file."""
    with open(output_file, "w") as f:
        f.write("MODULE main\n")
        f.write("VAR\n")
        f.write(" state : {" + ", ".join(f'"{state}"' for state in fsm.nodes) + "};\n")
        f.write(" owner : address;\n")
        f.write("ASSIGN\n")
        f.write(" init(state) := \"Start\";\n")
        f.write(" init(owner) := 0x0;\n")  # Initialize owner to 0 address

        # Define transitions using the case structure
        f.write(" next(state) := case\n")
        for edge in fsm.edges:
            f.write(f' state = "{edge[0]}" : "{edge[1]}";\n')
        f.write(" TRUE : state;\n")  # Default case to retain current state
        f.write(" esac;\n")

        # Add CTL properties
        for prop_name, ctl in ctl_properties.items():
            f.write(f"\n-- {prop_name}\n")
            f.write(f"SPEC {ctl};\n")

def write_command_file(output_file="commands.txt"):
    """Writes commands to a file for NuXmv."""
    with open(output_file, "w") as f:
        f.write("go_bmc\n")
        f.write("check_ltlspec\n")

def run_nuxmv(smv_file, command_file):
    """Runs the NuXmv model checker on the provided SMV file using a command file."""
    if not os.path.exists(nuxmv_path):
        raise FileNotFoundError(f"nuXmv binary not found at {nuxmv_path}")
    try:
        result = subprocess.run([nuxmv_path, "-source", command_file, smv_file], capture_output=True, text=True)
        if result.returncode != 0:
            print(f"NuXmv returned an error: {result.stderr}")
            return None
        return result.stdout
    except FileNotFoundError:
        print("NuXmv is not installed or not in PATH.")
        return None

# Step 4: Counterexample Analysis
def parse_counterexamples(nuxmv_output):
    """Parses counterexamples from NuXmv output."""
    if nuxmv_output and "-- specification" in nuxmv_output and "is false" in nuxmv_output:
        start = nuxmv_output.index("Counterexample")
        return nuxmv_output[start:]
    return "No counterexamples found."

# Step 5: Visualization
def visualize_fsm(fsm, filename="fsm_diagram.png"):
    """Visualizes the FSM using NetworkX and matplotlib."""
    plt.figure(figsize=(10, 6))  # Adjust figure size
    pos = nx.spring_layout(fsm)
    nx.draw(fsm, pos, with_labels=True, node_size=3000, node_color="lightblue", font_size=10, font_weight="bold")
    nx.draw_networkx_edges(fsm, pos, edge_color="gray", arrowstyle='->', arrowsize=20)
    plt.title("FSM Visualization", fontsize=14)
    plt.tight_layout()  # Adjust layout to prevent cropping
    plt.savefig(filename, dpi=300, bbox_inches='tight')  # Save with high DPI and tight bounding box
    plt.show()

def visualize_state_transitions(fsm, filename2="state_transitions.png"):
    """Visualizes state transitions as a bar chart."""
    transitions = list(fsm.edges)
    transition_counts = {edge: transitions.count(edge) for edge in transitions}

    plt.figure(figsize=(10, 6))  # Adjust figure size
    plt.bar(
        [f"{t[0]} → {t[1]}" for t in transition_counts.keys()],
        transition_counts.values(),
        color="skyblue"
    )
    plt.title("State Transition Frequencies", fontsize=14)
    plt.xlabel("Transitions", fontsize=12)
    plt.ylabel("Frequency", fontsize=12)
    plt.xticks(rotation=45, ha="right", fontsize=10)
    plt.yticks(fontsize=10)
    plt.tight_layout()  # Adjust layout to prevent cropping
    plt.savefig(filename2, dpi=300, bbox_inches='tight')  # Save with high DPI and tight bounding box
    plt.show()

# Example Usage
if __name__ == "__main__":
    solidity_code = """ 
    pragma solidity ^0.8.0;
    contract TxOriginVuln {
        address owner;

        constructor() {
            owner = msg.sender;
        }

        function withdrawAll() public {
            require(tx.origin == owner, "Not the owner!"); // ❌ Can be bypassed via phishing
            payable(msg.sender).transfer(address(this).balance);
        }
    }
    """

    # Convert Solidity code to BIP model
    bip_model = solidity_to_bip(solidity_code)
    fsm = bip_to_fsm(bip_model)

    # Define CTL properties for model checking
    ctl_properties = {
        "Tx Origin Vulnerability": "AG (state = \"WithdrawAttempted\" -> tx.origin == owner)",
    }

    # Write SMV file and command file, then run NuXmv
    write_smv_file(fsm, ctl_properties)
    write_command_file(command_file)
    nuxmv_output = run_nuxmv(smv_file, command_file)
    if nuxmv_output:
        print(nuxmv_output)
        counterexamples = parse_counterexamples(nuxmv_output)
        print("Counterexamples:", counterexamples)
    else:
        print("NuXmv execution failed.")

    # Visualize FSM and transitions
    visualize_fsm(fsm)
    visualize_state_transitions(fsm)